# WebSocket MCP 架構設計

## 架構概覽

```
┌─────────────────┐    stdio    ┌─────────────────────┐    WebSocket    ┌─────────────────────┐
│                 │ ──────────→ │                     │ ──────────────→ │                     │
│     Cursor      │             │   MCP Server        │                 │   VS Code           │
│                 │             │   (WebSocket        │                 │   Extension         │
│                 │             │    Client)          │                 │   (WebSocket        │
│                 │             │                     │                 │    Server)          │
└─────────────────┘             └─────────────────────┘                 └─────────────────────┘
                                        │                                        │
                                        │                                        │
                                        │  Process Management                    │  VSCode API
                                        │  & Health Monitoring                  │  & Commands
                                        │                                        │
                                        ▼                                        ▼
                                ┌─────────────────────┐                 ┌─────────────────────┐
                                │                     │                 │                     │
                                │   Process Manager   │                 │   VSCode Commands   │
                                │                     │                 │   Tools             │
                                │   - Start/Stop      │                 │   - executeCommand  │
                                │   - Restart         │                 │   - listCommands    │
                                │   - Health Check    │                 │                     │
                                └─────────────────────┘                 └─────────────────────┘
```

## 組件詳細說明

### 1. Cursor
- **角色**: MCP 客戶端
- **通信方式**: stdio (標準輸入輸出)
- **職責**: 發送 MCP 請求，接收響應

### 2. MCP Server (WebSocket Client)
- **角色**: 中間層，橋接 stdio 和 WebSocket
- **通信方式**: 
  - 輸入: stdio (來自 Cursor)
  - 輸出: WebSocket (到 Extension)
- **職責**: 
  - 處理 stdio 輸入輸出
  - 轉換為 WebSocket 消息
  - 管理 WebSocket 連接
  - 實現重連和錯誤恢復

### 3. VS Code Extension (WebSocket Server)
- **角色**: WebSocket 服務器，VSCode 命令執行器
- **通信方式**: WebSocket
- **職責**:
  - 監聽 WebSocket 連接
  - 處理 MCP 請求
  - 執行 VSCode 命令
  - 返回執行結果

## 數據流

### 1. 請求流程
```
Cursor → stdio → MCP Server → WebSocket → Extension → VSCode API → 執行命令
```

### 2. 響應流程
```
執行結果 → VSCode API → Extension → WebSocket → MCP Server → stdio → Cursor
```

### 3. 錯誤處理流程
```
錯誤發生 → 錯誤檢測 → 錯誤分類 → 錯誤處理 → 恢復或重試
```

## 進程架構

### 1. 進程分離
```
┌─────────────────────────────────────────────────────────────────┐
│                    VS Code Extension Process                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │                 │  │                 │  │                 │ │
│  │ WebSocket       │  │ VSCode Commands │  │ Extension       │ │
│  │ Server          │  │ Tools           │  │ Management      │ │
│  │                 │  │                 │  │                 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                        │
                                        │ WebSocket Communication
                                        │
┌─────────────────────────────────────────────────────────────────┐
│                    MCP Server Process                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │                 │  │                 │  │                 │ │
│  │ stdio Handler   │  │ WebSocket       │  │ Process         │ │
│  │                 │  │ Client          │  │ Manager         │ │
│  │                 │  │                 │  │                 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 進程管理
- **Extension Process**: 由 VS Code 管理，負責 WebSocket 服務和 VSCode 命令執行
- **MCP Server Process**: 由 Extension 啟動和管理，負責 stdio 處理和 WebSocket 客戶端

## 通信協議

### 1. WebSocket 消息格式
```typescript
interface WebSocketMessage {
  id: string;           // 唯一標識符
  type: MessageType;    // 消息類型
  timestamp: number;    // 時間戳
  data: any;           // 消息數據
  error?: string;      // 錯誤信息（可選）
}
```

### 2. 消息類型
- **MCP_REQUEST**: MCP 協議請求
- **MCP_RESPONSE**: MCP 協議響應
- **HEARTBEAT**: 心跳檢測
- **CONNECT**: 連接管理
- **ERROR**: 錯誤處理

### 3. MCP 協議映射
```typescript
// 工具列表請求
{
  "jsonrpc": "2.0",
  "id": "list_tools",
  "method": "tools/list",
  "params": {}
}

// 工具調用請求
{
  "jsonrpc": "2.0",
  "id": "call_tool",
  "method": "tools/call",
  "params": {
    "name": "executeCommand",
    "arguments": {
      "command": "workbench.action.files.newFile"
    }
  }
}
```

## 錯誤處理策略

### 1. 分層錯誤處理
```
┌─────────────────┐
│   Application   │ ← 應用級錯誤處理
├─────────────────┤
│   Transport     │ ← 傳輸級錯誤處理
├─────────────────┤
│   Network       │ ← 網絡級錯誤處理
├─────────────────┤
│   System        │ ← 系統級錯誤處理
└─────────────────┘
```

### 2. 錯誤恢復機制
- **連接斷開**: 自動重連，指數退避策略
- **進程崩潰**: 自動重啟，最大重試次數限制
- **消息錯誤**: 錯誤響應，不影響其他消息
- **系統錯誤**: 日誌記錄，錯誤通知

## 性能優化

### 1. 連接管理
- **連接池**: 管理多個 WebSocket 連接
- **連接復用**: 重用現有連接
- **負載均衡**: 分散連接負載

### 2. 消息處理
- **消息緩衝**: 批量處理消息
- **異步處理**: 非阻塞消息處理
- **優先級隊列**: 重要消息優先處理

### 3. 資源管理
- **記憶體優化**: 限制緩衝區大小
- **CPU 優化**: 避免阻塞操作
- **網絡優化**: 減少不必要的網絡請求

## 監控和診斷

### 1. 健康檢查
- **進程健康**: 檢查進程狀態
- **連接健康**: 檢查連接狀態
- **性能健康**: 檢查性能指標

### 2. 性能監控
- **延遲監控**: 消息處理延遲
- **吞吐量監控**: 消息處理速率
- **錯誤率監控**: 錯誤發生頻率

### 3. 日誌系統
- **結構化日誌**: JSON 格式日誌
- **日誌級別**: Debug, Info, Warn, Error
- **日誌輪轉**: 自動清理舊日誌

## 安全考慮

### 1. 連接安全
- **來源驗證**: 驗證連接來源
- **消息驗證**: 驗證消息格式
- **大小限制**: 限制消息大小

### 2. 進程安全
- **進程隔離**: 錯誤不會影響其他進程
- **資源限制**: 限制進程資源使用
- **權限控制**: 控制進程權限

## 擴展性設計

### 1. 水平擴展
- **多進程**: 支援多個 MCP 服務器進程
- **負載均衡**: 自動分配負載
- **故障轉移**: 自動故障轉移

### 2. 垂直擴展
- **資源優化**: 優化單進程性能
- **緩存策略**: 實現智能緩存
- **並發處理**: 提高並發處理能力

### 3. 功能擴展
- **插件系統**: 支援功能插件
- **配置管理**: 靈活的配置管理
- **API 擴展**: 可擴展的 API 接口

## 部署和配置

### 1. 部署模式
- **單機部署**: 單機運行
- **集群部署**: 多節點集群
- **容器部署**: Docker 容器化

### 2. 配置管理
- **環境變量**: 環境相關配置
- **配置文件**: 靜態配置文件
- **動態配置**: 運行時配置更新

### 3. 監控部署
- **日誌收集**: 集中日誌收集
- **指標收集**: 集中指標收集
- **告警系統**: 自動告警通知
